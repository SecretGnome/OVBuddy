<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OVBuddy Terminal Interface</title>
    <link rel="stylesheet" href="/static/css/terminal.css" id="themeStylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="terminal-header">
            <h1 class="terminal-title">OVBuddy Terminal Interface</h1>
            <p class="terminal-subtitle">System Configuration & Management Console</p>

            <!-- Theme Toggle Button -->
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                <span id="themeIcon">☀️</span>
                <span id="themeText">Bright Theme</span>
            </button>
        </div>

        <!-- Message Display -->
        <div id="message" class="message"></div>

        <!-- Restart Snackbar -->
        <div id="restartSnackbar" class="snackbar" style="display: none;">
            <span id="restartSnackbarText">Configuration changed. Please restart the ovbuddy service for changes to take effect.</span>
            <button id="restartServiceButton" class="snackbar-button" onclick="restartServiceFromSnackbar()">Restart Service</button>
        </div>

        <!-- Web Authentication Section -->
        <div class="terminal-window">
            <div class="terminal-window-header">
                <h2 class="terminal-window-title">web auth (Basic)</h2>
                <div class="terminal-window-controls">
                    <span class="terminal-control close"></span>
                    <span class="terminal-control minimize"></span>
                    <span class="terminal-control maximize"></span>
                </div>
            </div>
            <div class="terminal-window-body">
                <div class="help-text" style="margin-bottom: 10px;">
                    <strong>Status:</strong> <span id="webAuthStatusText">Loading...</span>
                </div>
                <form id="webAuthForm">
                    <div class="two-column-grid">
                        <div class="form-group">
                            <label for="webAuthUsername">Username</label>
                            <input type="text" id="webAuthUsername" name="webAuthUsername" autocomplete="username">
                            <div class="help-text">Active username for the web interface</div>
                        </div>
                        <div class="form-group">
                            <label for="webAuthPassword">New Password</label>
                            <input type="password" id="webAuthPassword" name="webAuthPassword" autocomplete="new-password" placeholder="(leave empty to keep unchanged)">
                            <div class="help-text">Min 8 characters</div>
                        </div>
                        <div class="form-group">
                            <label for="webAuthPasswordConfirm">Confirm Password</label>
                            <input type="password" id="webAuthPasswordConfirm" name="webAuthPasswordConfirm" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <button type="submit">Update Web Login</button>
                            <button type="button" class="secondary" onclick="rotateWebAuth()">Rotate (Generate New Password)</button>
                        </div>
                    </div>
                </form>
                <div class="help-text" style="margin-top: 10px;">
                    After updating, your browser may prompt again for credentials on refresh.
                </div>
            </div>
        </div>

        <!-- Configuration Section (2-column form) -->
        <div class="terminal-window">
            <div class="terminal-window-header">
                <h2 class="terminal-window-title">config.json</h2>
                <div class="terminal-window-controls">
                    <span class="terminal-control close"></span>
                    <span class="terminal-control minimize"></span>
                    <span class="terminal-control maximize"></span>
                </div>
            </div>
            <div class="terminal-window-body">
                <form id="configForm">
                    <div class="two-column-grid">
                        <div class="form-group span-2">
                            <label for="stations">Stations (one per line)</label>
                            <textarea id="stations" name="stations" placeholder="Zürich Saalsporthalle&#10;Zürich, Saalsporthalle"></textarea>
                            <div class="help-text">Enter station names, one per line</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="lines">Lines (comma-separated)</label>
                            <input type="text" id="lines" name="lines" placeholder="S4, T13, T5">
                            <div class="help-text">Enter line numbers separated by commas</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="refresh_interval">Refresh Interval (seconds)</label>
                            <input type="number" id="refresh_interval" name="refresh_interval" min="1" step="1">
                            <div class="help-text">How often to update the display</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="qr_code_display_duration">QR Code Display Duration (seconds)</label>
                            <input type="number" id="qr_code_display_duration" name="qr_code_display_duration" min="0" step="1">
                            <div class="help-text">How long to show QR code on startup (0 to skip)</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="max_departures">Max Departures</label>
                            <input type="number" id="max_departures" name="max_departures" min="1" max="20" step="1">
                            <div class="help-text">Maximum number of connections to display</div>
                        </div>

                        <div class="form-group span-2">
                            <label for="destination_prefixes_to_remove">Destination Prefixes to Remove (one per line)</label>
                            <textarea id="destination_prefixes_to_remove" name="destination_prefixes_to_remove" placeholder="Zurich &#10;Zurich, &#10;Zürich "></textarea>
                            <div class="help-text">Prefixes to remove from destination names</div>
                        </div>
                        
                        <div class="form-group span-2">
                            <label for="destination_exceptions">Destination Exceptions (comma-separated)</label>
                            <input type="text" id="destination_exceptions" name="destination_exceptions" placeholder="HB, Hbf">
                            <div class="help-text">Destinations that should never have prefixes removed</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="inverted" name="inverted">
                                Inverted Display (white text on black background)
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label for="display_orientation">Display Orientation (Ports)</label>
                            <select id="display_orientation" name="display_orientation">
                                <option value="bottom">Bottom (default)</option>
                                <option value="top">Top</option>
                                <option value="left">Left (90° CW)</option>
                                <option value="right">Right (90° CCW)</option>
                            </select>
                            <div class="help-text">Choose the device orientation by where the ports are</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="use_partial_refresh" name="use_partial_refresh">
                                Use Partial Refresh (less flashing, may have ghosting)
                            </label>
                        </div>
                        
                        <div class="form-group span-2">
                            <label class="checkbox-label">
                                <input type="checkbox" id="auto_update" name="auto_update">
                                Auto-update on startup (automatically install updates when available)
                            </label>
                            <div class="help-text">When enabled, the system will automatically update and restart when a new version is available</div>
                        </div>
                        
                        <div class="form-group span-2">
                            <label class="checkbox-label">
                                <input type="checkbox" id="ap_fallback_enabled" name="ap_fallback_enabled">
                                Enable WiFi Access Point Fallback
                            </label>
                            <div class="help-text">When enabled, the device will create its own WiFi network if it can't connect to a configured network</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="ap_ssid">Access Point Name (SSID)</label>
                            <input type="text" id="ap_ssid" name="ap_ssid" placeholder="OVBuddy">
                            <div class="help-text">The name of the WiFi network when in access point mode</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="ap_password">Access Point Password</label>
                            <input type="password" id="ap_password" name="ap_password" placeholder="Leave empty for open network">
                            <div class="help-text">Password for the access point (leave empty for no password)</div>
                        </div>
                        
                        <div class="form-group span-2">
                            <label class="checkbox-label">
                                <input type="checkbox" id="display_ap_password" name="display_ap_password">
                                Display password on screen when in AP mode
                            </label>
                            <div class="help-text">When enabled, the password will be shown on the e-ink display (useful for initial setup)</div>
                        </div>
                        
                        <div class="form-group span-2">
                            <button type="submit">Save Configuration</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Service Management Section (2-column service cards) -->
        <div class="terminal-window">
            <div class="terminal-window-header">
                <h2 class="terminal-window-title">systemctl status</h2>
                <div class="terminal-window-controls">
                    <span class="terminal-control close"></span>
                    <span class="terminal-control minimize"></span>
                    <span class="terminal-control maximize"></span>
                </div>
            </div>
            <div class="terminal-window-body">
                <div id="servicesSection">
                    <div id="servicesStatus" class="services-grid">
                        <p style="text-align: center;">Loading service status...</p>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" onclick="refreshServicesStatus()" class="secondary">Refresh Status</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- WiFi Management Section -->
        <div class="terminal-window">
            <div class="terminal-window-header">
                <h2 class="terminal-window-title">iwconfig</h2>
                <div class="terminal-window-controls">
                    <span class="terminal-control close"></span>
                    <span class="terminal-control minimize"></span>
                    <span class="terminal-control maximize"></span>
                </div>
            </div>
            <div class="terminal-window-body">
                <div id="wifiSection">
                    <div id="wifiStatus" class="wifi-status">
                        <strong>Status:</strong> <span id="wifiStatusText">Loading...</span><br>
                        <span id="wifiDetails"></span>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" id="scanButton" class="secondary" onclick="scanNetworks()">Scan for Networks</button>
                        <button type="button" id="refreshStatusButton" onclick="refreshWifiStatus()">Refresh Status</button>
                        <button type="button" id="forceApButton" onclick="forceApMode()" style="background: #d97706;">Force AP Mode</button>
                        <button type="button" id="clearKnownNetworksButton" onclick="clearKnownNetworks()" class="danger">Clear Known Networks</button>
                    </div>
                    
                    <div id="networkListContainer" style="display: none;">
                        <div class="form-group">
                            <label>Available Networks</label>
                            <div id="networkList" class="network-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shutdown Section -->
        <div class="terminal-window">
            <div class="terminal-window-header">
                <h2 class="terminal-window-title">shutdown</h2>
                <div class="terminal-window-controls">
                    <span class="terminal-control close"></span>
                    <span class="terminal-control minimize"></span>
                    <span class="terminal-control maximize"></span>
                </div>
            </div>
            <div class="terminal-window-body">
                <div id="shutdownSection">
                    <p style="margin-bottom: 15px;">Stop the ovbuddy service and clear the display. Optionally upload an image to display after clearing.</p>
                    
                    <div class="form-group">
                        <label for="shutdownImage">Optional: Upload image to display (JPG/PNG)</label>
                        <input type="file" id="shutdownImage" name="shutdownImage" accept="image/jpeg,image/jpg,image/png">
                        <div class="help-text">Image will be resized and centered on the display</div>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" id="shutdownButton" onclick="shutdownDisplay()" class="danger">Shutdown & Clear Display</button>
                        <button type="button" id="rebootButton" onclick="rebootPi()" class="warning">Reboot Pi</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 12px;">
            <p>OVBuddy Web Interface | System Online | Press Cmd + W to exit</p>
            <div id="versionInfo" style="margin-top: 10px; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px; display: inline-block;">
                <span id="versionText">Loading version...</span>
            </div>
            <p style="margin-top: 10px;">
                Want to contribute? Check out the project on 
                <a href="https://github.com/SecretGnome/OVBuddy" target="_blank" style="color: var(--primary-color); text-decoration: none;">GitHub</a>
            </p>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>

