<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OVBuddy Terminal Interface</title>
    <link rel="stylesheet" href="/static/css/terminal.css" id="themeStylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="terminal-header">
            <div class="terminal-header-top">
                <div class="terminal-header-text">
                    <h1 class="terminal-title">OVBuddy Terminal Interface</h1>
                    <p class="terminal-subtitle">System Configuration & Management Console</p>
                </div>

                <!-- Theme Toggle Button -->
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                    <span id="themeIcon">☀️</span>
                    <span id="themeText">Bright Theme</span>
                </button>
            </div>
        </div>

        <!-- Message Display -->
        <div id="message" class="message"></div>

        <!-- Restart Snackbar -->
        <div id="restartSnackbar" class="snackbar" style="display: none;">
            <span id="restartSnackbarText">Configuration changed. Please restart the ovbuddy service for changes to take effect.</span>
            <button id="restartServiceButton" class="snackbar-button" onclick="restartServiceFromSnackbar()">Restart Service</button>
        </div>

        <!-- Web Authentication Section -->
        <div class="terminal-window" id="webAuthWindow" data-module="web_auth_basic">
            <div class="terminal-window-header">
                <h2 class="terminal-window-title">web auth (Basic) <span class="module-badge" data-module-badge="web_auth_basic">DISABLED</span></h2>
                <div class="terminal-window-controls">
                    <label class="header-toggle">
                        <input type="checkbox" data-module-toggle="web_auth_basic">
                        <span>Enabled</span>
                    </label>
                    <span class="terminal-control close"></span>
                    <span class="terminal-control minimize"></span>
                    <span class="terminal-control maximize"></span>
                </div>
            </div>
            <div class="terminal-window-body">
                <div class="help-text" style="margin-bottom: 10px;">
                    <strong>Status:</strong> <span id="webAuthStatusText">Loading...</span>
                </div>
                <form id="webAuthForm">
                    <div class="two-column-grid">
                        <div class="form-group">
                            <label for="webAuthUsername">Username</label>
                            <input type="text" id="webAuthUsername" name="webAuthUsername" autocomplete="username">
                            <div class="help-text">Active username for the web interface</div>
                        </div>
                        <div class="form-group">
                            <label for="webAuthPassword">New Password</label>
                            <input type="password" id="webAuthPassword" name="webAuthPassword" autocomplete="new-password" placeholder="(leave empty to keep unchanged)">
                            <div class="help-text">Min 8 characters</div>
                        </div>
                        <div class="form-group">
                            <label for="webAuthPasswordConfirm">Confirm Password</label>
                            <input type="password" id="webAuthPasswordConfirm" name="webAuthPasswordConfirm" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <button type="submit">Update Web Login</button>
                            <button type="button" class="secondary" onclick="rotateWebAuth()">Rotate (Generate New Password)</button>
                            <button type="button" class="secondary" id="webAuthReloadButton" style="display: none;" onclick="reloadForWebAuth()">Reload & Login</button>
                        </div>
                    </div>
                </form>
                <div class="help-text" style="margin-top: 10px;">
                    After updating, your browser may prompt again for credentials on refresh.
                </div>
            </div>
        </div>

        <!-- Configuration Section (2-column form) -->
        <div class="terminal-window" id="configWindow" data-module="config_json">
            <div class="terminal-window-header">
                <h2 class="terminal-window-title">config.json <span class="module-badge" data-module-badge="config_json">DISABLED</span></h2>
                <div class="terminal-window-controls">
                    <label class="header-toggle">
                        <input type="checkbox" data-module-toggle="config_json">
                        <span>Enabled</span>
                    </label>
                    <span class="terminal-control close"></span>
                    <span class="terminal-control minimize"></span>
                    <span class="terminal-control maximize"></span>
                </div>
            </div>
            <div class="terminal-window-body">
                <form id="configForm">
                    <!-- Data & Logic Section -->
                    <div class="config-section">
                        <h3 class="section-header" onclick="toggleSection('dataLogicSection')">
                            <span class="section-icon">▼</span> Data & Logic
                        </h3>
                        <div id="dataLogicSection" class="section-content">
                            <div class="two-column-grid">
                                <div class="form-group span-2">
                                    <label for="stations">Stations <span class="help-icon" title="Enter station names, one per line">ⓘ</span></label>
                                    <textarea id="stations" name="stations" rows="3" placeholder="Zürich Saalsporthalle&#10;Zürich, Saalsporthalle"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="lines">Lines <span class="help-icon" title="Enter line numbers separated by commas">ⓘ</span></label>
                                    <input type="text" id="lines" name="lines" placeholder="S4, T13, T5">
                                </div>
                                
                                <div class="form-group">
                                    <label for="max_departures">Max Departures <span class="help-icon" title="Maximum number of connections to display">ⓘ</span></label>
                                    <input type="number" id="max_departures" name="max_departures" min="1" max="20" step="1">
                                </div>

                                <div class="form-group span-2">
                                    <label for="destination_prefixes_to_remove">Destination Prefixes to Remove <span class="help-icon" title="Prefixes to remove from destination names (one per line)">ⓘ</span></label>
                                    <textarea id="destination_prefixes_to_remove" name="destination_prefixes_to_remove" rows="2" placeholder="Zurich &#10;Zurich, &#10;Zürich "></textarea>
                                </div>
                                
                                <div class="form-group span-2">
                                    <label for="destination_exceptions">Destination Exceptions <span class="help-icon" title="Destinations that should never have prefixes removed">ⓘ</span></label>
                                    <input type="text" id="destination_exceptions" name="destination_exceptions" placeholder="HB, Hbf">
                                </div>
                                
                                <div class="form-group">
                                    <label for="refresh_interval">Refresh Interval (seconds) <span class="help-icon" title="How often to update the display">ⓘ</span></label>
                                    <input type="number" id="refresh_interval" name="refresh_interval" min="1" step="1">
                                </div>
                                
                                <div class="form-group">
                                    <label for="qr_code_display_duration">QR Code Duration (seconds) <span class="help-icon" title="How long to show QR code on startup (0 to skip)">ⓘ</span></label>
                                    <input type="number" id="qr_code_display_duration" name="qr_code_display_duration" min="0" step="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Display & Output Section -->
                    <div class="config-section">
                        <h3 class="section-header" onclick="toggleSection('displayOutputSection')">
                            <span class="section-icon">▼</span> Display & Output
                        </h3>
                        <div id="displayOutputSection" class="section-content">
                            <div class="two-column-grid">
                                <div class="form-group">
                                    <label for="departure_layout">Layout <span class="help-icon" title="1 row: line, destination, time on one line; 2 rows: line and time on first row, destination on second">ⓘ</span></label>
                                    <select id="departure_layout" name="departure_layout">
                                        <option value="1row">1 Row (compact)</option>
                                        <option value="2row">2 Rows (detailed)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="display_orientation">Orientation <span class="help-icon" title="Choose orientation by where the ports are located">ⓘ</span></label>
                                    <select id="display_orientation" name="display_orientation">
                                        <option value="bottom">Bottom (default)</option>
                                        <option value="top">Top</option>
                                        <option value="left">Left (90° CW)</option>
                                        <option value="right">Right (90° CCW)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="inverted" name="inverted">
                                        Inverted Colors <span class="help-icon" title="White text on black background">ⓘ</span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="use_partial_refresh" name="use_partial_refresh">
                                        Partial Refresh <span class="help-icon" title="Less flashing, may have ghosting (e-ink only)">ⓘ</span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="destination_scroll" name="destination_scroll">
                                        Scroll Destinations <span class="help-icon" title="Scrolling text like old train displays (LCD only)">ⓘ</span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label for="scroll_speed_factor">Scroll Speed <span class="help-icon" title="0.1-5.0, default 1.0. Higher = faster">ⓘ</span></label>
                                    <input type="number" id="scroll_speed_factor" name="scroll_speed_factor" min="0.1" max="5.0" step="0.1">
                                </div>
                                
                                <div class="form-group">
                                    <label for="lcd_refresh_rate">LCD Refresh Rate (FPS) <span class="help-icon" title="1-60, default 30. Higher = smoother but more CPU">ⓘ</span></label>
                                    <input type="number" id="lcd_refresh_rate" name="lcd_refresh_rate" min="1" max="60" step="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System & WiFi Section -->
                    <div class="config-section">
                        <h3 class="section-header" onclick="toggleSection('systemWifiSection')">
                            <span class="section-icon">▼</span> System & WiFi
                        </h3>
                        <div id="systemWifiSection" class="section-content">
                            <div class="two-column-grid">
                                <div class="form-group span-2">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="auto_update" name="auto_update">
                                        Auto-update on startup <span class="help-icon" title="Automatically install updates when available">ⓘ</span>
                                    </label>
                                </div>
                                
                                <div class="form-group span-2">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="ap_fallback_enabled" name="ap_fallback_enabled">
                                        Enable WiFi AP Fallback <span class="help-icon" title="Create own WiFi network if can't connect to configured network">ⓘ</span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label for="ap_ssid">AP Name (SSID) <span class="help-icon" title="Name of WiFi network in access point mode">ⓘ</span></label>
                                    <input type="text" id="ap_ssid" name="ap_ssid" placeholder="OVBuddy">
                                </div>
                                
                                <div class="form-group">
                                    <label for="ap_password">AP Password <span class="help-icon" title="Leave empty for open network">ⓘ</span></label>
                                    <input type="password" id="ap_password" name="ap_password" placeholder="Leave empty for open network">
                                </div>
                                
                                <div class="form-group span-2">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="display_ap_password" name="display_ap_password">
                                        Display password on screen in AP mode <span class="help-icon" title="Show password on e-ink display (useful for initial setup)">ⓘ</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <button type="submit">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Service Management Section (2-column service cards) -->
        <div class="terminal-window" id="servicesWindow" data-module="systemctl_status">
            <div class="terminal-window-header">
                <h2 class="terminal-window-title">systemctl status <span class="module-badge" data-module-badge="systemctl_status">DISABLED</span></h2>
                <div class="terminal-window-controls">
                    <label class="header-toggle">
                        <input type="checkbox" data-module-toggle="systemctl_status">
                        <span>Enabled</span>
                    </label>
                    <span class="terminal-control close"></span>
                    <span class="terminal-control minimize"></span>
                    <span class="terminal-control maximize"></span>
                </div>
            </div>
            <div class="terminal-window-body">
                <div id="servicesSection">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sshEnableOnBoot">
                            SSH: start on boot
                        </label>
                        <div class="help-text">Toggles whether `ssh.service` is enabled (systemctl enable/disable)</div>
                    </div>
                    <div id="servicesStatus" class="services-grid">
                        <p style="text-align: center;">Loading service status...</p>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" onclick="refreshServicesStatus()" class="secondary">Refresh Status</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- WiFi Management Section -->
        <div class="terminal-window" id="wifiWindow" data-module="iwconfig">
            <div class="terminal-window-header">
                <h2 class="terminal-window-title">iwconfig <span class="module-badge" data-module-badge="iwconfig">DISABLED</span></h2>
                <div class="terminal-window-controls">
                    <label class="header-toggle">
                        <input type="checkbox" data-module-toggle="iwconfig">
                        <span>Enabled</span>
                    </label>
                    <span class="terminal-control close"></span>
                    <span class="terminal-control minimize"></span>
                    <span class="terminal-control maximize"></span>
                </div>
            </div>
            <div class="terminal-window-body">
                <div id="wifiSection">
                    <div id="wifiStatus" class="wifi-status">
                        <strong>Status:</strong> <span id="wifiStatusText">Loading...</span><br>
                        <span id="wifiDetails"></span>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" id="scanButton" class="secondary" onclick="scanNetworks()">Scan for Networks</button>
                        <button type="button" id="refreshStatusButton" onclick="refreshWifiStatus()">Refresh Status</button>
                        <button type="button" id="forceApButton" onclick="forceApMode()" style="background: #d97706;">Force AP Mode</button>
                        <button type="button" id="clearKnownNetworksButton" onclick="clearKnownNetworks()" class="danger">Clear Known Networks</button>
                    </div>
                    
                    <!-- Manual WiFi Connection Form -->
                    <div class="form-group" style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 15px;">
                        <label>Manual WiFi Connection</label>
                        <div style="margin-bottom: 10px; color: var(--text-secondary); font-size: 0.9em;">
                            Enter WiFi credentials manually (useful when scanning is unavailable in AP mode)
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <input type="text" id="manualSsid" placeholder="WiFi Network Name (SSID)" autocomplete="off" style="width: 100%; padding: 8px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); font-family: 'Courier New', monospace;">
                            <input type="password" id="manualPassword" placeholder="WiFi Password (leave empty for open networks)" autocomplete="new-password" style="width: 100%; padding: 8px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); font-family: 'Courier New', monospace;">
                            <button type="button" id="manualConnectButton" onclick="connectManually()" class="primary" style="align-self: flex-start;">Connect to Network</button>
                        </div>
                    </div>
                    
                    <div id="networkListContainer" style="display: none;">
                        <div class="form-group">
                            <label>Available Networks</label>
                            <div id="networkList" class="network-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shutdown Section -->
        <div class="terminal-window" id="shutdownWindow" data-module="shutdown">
            <div class="terminal-window-header">
                <h2 class="terminal-window-title">shutdown <span class="module-badge" data-module-badge="shutdown">DISABLED</span></h2>
                <div class="terminal-window-controls">
                    <label class="header-toggle">
                        <input type="checkbox" data-module-toggle="shutdown">
                        <span>Enabled</span>
                    </label>
                    <span class="terminal-control close"></span>
                    <span class="terminal-control minimize"></span>
                    <span class="terminal-control maximize"></span>
                </div>
            </div>
            <div class="terminal-window-body">
                <div id="shutdownSection">
                    <p style="margin-bottom: 15px;">Stop the ovbuddy service and clear the display. Optionally upload an image to display after clearing.</p>
                    
                    <div class="form-group">
                        <label for="shutdownImage">Optional: Upload image to display (JPG/PNG)</label>
                        <input type="file" id="shutdownImage" name="shutdownImage" accept="image/jpeg,image/jpg,image/png">
                        <div class="help-text">Image will be resized and centered on the display</div>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" id="shutdownButton" onclick="shutdownDisplay()" class="danger">Shutdown & Clear Display</button>
                        <button type="button" id="rebootButton" onclick="rebootPi()" class="warning">Reboot Pi</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 12px;">
            <p>OVBuddy Web Interface | System Online | Press Cmd + W to exit</p>
            <div id="versionInfo" style="margin-top: 10px; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px; display: inline-block;">
                <span id="versionText">Loading version...</span>
            </div>
            <p style="margin-top: 10px;">
                Want to contribute? Check out the project on 
                <a href="https://github.com/SecretGnome/OVBuddy" target="_blank" style="color: var(--primary-color); text-decoration: none;">GitHub</a>
            </p>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>
